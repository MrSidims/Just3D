name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  validate-and-build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Validate manifest.json
      run: |
        echo "================================"
        echo "VALIDATION: manifest.json"
        echo "================================"

        echo ""
        echo "Checking JSON syntax..."
        if ! jq empty manifest.json 2>/dev/null; then
          echo "  [FAIL] manifest.json is not valid JSON"
          exit 1
        fi
        echo "  [PASS] Valid JSON syntax"

        echo ""
        echo "Checking required fields..."

        echo "  - manifest_version..."
        if ! jq -e '.manifest_version' manifest.json > /dev/null; then
          echo "    [FAIL] Missing manifest_version"
          exit 1
        fi
        echo "    [PASS] Found: $(jq -r '.manifest_version' manifest.json)"

        echo "  - name..."
        if ! jq -e '.name' manifest.json > /dev/null; then
          echo "    [FAIL] Missing name"
          exit 1
        fi
        echo "    [PASS] Found: $(jq -r '.name' manifest.json)"

        echo "  - version..."
        if ! jq -e '.version' manifest.json > /dev/null; then
          echo "    [FAIL] Missing version"
          exit 1
        fi
        echo "    [PASS] Found: $(jq -r '.version' manifest.json)"

        echo "  - description..."
        if ! jq -e '.description' manifest.json > /dev/null; then
          echo "    [FAIL] Missing description"
          exit 1
        fi
        echo "    [PASS] Found: $(jq -r '.description' manifest.json)"

        echo ""
        echo "[PASS] manifest.json validation complete"
        echo ""

    - name: Check required files
      run: |
        echo "================================"
        echo "VALIDATION: Required Files"
        echo "================================"
        echo ""

        required_files=(
          "manifest.json"
          "popup.html"
          "viewer.html"
          "scripts/popup.js"
          "scripts/viewer.js"
          "scripts/background.js"
          "scripts/i18n.js"
          "scripts/storage-helper.js"
          "scripts/texture-generator.js"
          "styles/popup.css"
          "styles/viewer.css"
          "assets/preview2.png"
          "assets/icon128.png"
          "LICENSE"
          "README.md"
        )

        missing_files=()
        found_count=0

        for file in "${required_files[@]}"; do
          if [ ! -f "$file" ]; then
            echo "  [MISSING] $file"
            missing_files+=("$file")
          else
            echo "  [FOUND] $file"
            found_count=$((found_count + 1))
          fi
        done

        echo ""
        echo "Summary: $found_count/${#required_files[@]} files found"

        if [ ${#missing_files[@]} -gt 0 ]; then
          echo ""
          echo "[FAIL] Validation failed: ${#missing_files[@]} required file(s) missing"
          exit 1
        fi

        echo ""
        echo "[PASS] All required files present"
        echo ""

    - name: Check file sizes
      run: |
        echo "================================"
        echo "VALIDATION: File Sizes"
        echo "================================"
        echo ""
        echo "Scanning for files larger than 5MB..."
        echo ""

        large_files=$(find . -type f -size +5M -not -path "./.git/*" -not -path "./node_modules/*" -not -path "./dist/*" -not -path "./release/*")

        if [ -n "$large_files" ]; then
          echo "[WARNING] Large files detected (>5MB):"
          echo ""
          while IFS= read -r file; do
            size=$(du -h "$file" | cut -f1)
            echo "  $file ($size)"
          done <<< "$large_files"
          echo ""
          echo "[WARNING] Consider optimizing or excluding these files"
        else
          echo "  [PASS] No large files found"
        fi
        echo ""

    - name: Get version from manifest
      id: version
      run: |
        echo "================================"
        echo "Reading Version"
        echo "================================"
        echo ""

        VERSION=$(jq -r '.version' manifest.json)
        echo "version=$VERSION" >> $GITHUB_OUTPUT

        echo "Extension version: $VERSION"
        echo ""

    - name: Create extension package
      run: |
        echo "================================"
        echo "Creating Extension Package"
        echo "================================"
        echo ""

        mkdir -p dist

        echo "Packaging files..."
        echo ""

        # Create zip excluding development files
        zip -r dist/just3d-${{ steps.version.outputs.version }}.zip . \
          -x "*.git*" \
          -x "*node_modules/*" \
          -x "*dist/*" \
          -x "*DevDir/*" \
          -x "*.md" \
          -x "*icons/*" \
          -x "*.github/*" \
          -q

        echo "  [PASS] Package created: just3d-${{ steps.version.outputs.version }}.zip"
        echo ""

        echo "Package details:"
        ls -lh dist/ | grep ".zip" | awk '{print "  Size: " $5}'
        echo ""

    - name: Upload extension artifact
      uses: actions/upload-artifact@v4
      with:
        name: just3d-extension-${{ steps.version.outputs.version }}
        path: dist/*.zip
        retention-days: 30

    - name: Extension info
      run: |
        echo "================================"
        echo "Extension Summary"
        echo "================================"
        echo ""
        echo "Extension Information:"
        echo "  Name: $(jq -r '.name' manifest.json)"
        echo "  Version: ${{ steps.version.outputs.version }}"
        echo "  Description: $(jq -r '.description' manifest.json)"
        echo "  Manifest Version: $(jq -r '.manifest_version' manifest.json)"
        echo ""
        echo "Package Information:"
        du -h dist/*.zip | awk '{print "  File: " $2 " (" $1 ")"}'
        echo ""
        echo "================================"
        echo "[PASS] CI Pipeline Complete"
        echo "================================"
